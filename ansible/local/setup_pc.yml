---
- name: "Setup Stateless DevOps"
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    nvme_path: "/var/mnt/nvme"
    # Modern syntax to avoid Warnings
    workspace_dir: "{{ ansible_facts['env']['HOME'] }}/Workspace"
    dotfiles_dir: "{{ workspace_dir }}/repos/dotfiles"

    # Git Identity
    git_name: "Ariel F."
    git_email: "50802265+ariel99gf@users.noreply.github.com"

    repositories:
      - { name: "homelab", url: "git@github.com:ariel99gf/homelab.git" }
      - { name: "dotfiles", url: "git@github.com:ariel99gf/dotfiles.git" }
      - { name: "albastore", url: "git@github.com:ariel99gf/albastore.git" }
      - { name: "My-notes", url: "git@github.com:ariel99gf/My-notes.git" }

  tasks:
    # 1. SSH Configuration
    - name: "Ensure GitHub is in known_hosts"
      known_hosts:
        name: github.com
        key: "{{ lookup('pipe', 'ssh-keyscan github.com') }}"
        state: present

    # 2. NVMe Infrastructure
    - name: "Ensure directory structure on NVMe"
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      with_items:
        - "{{ nvme_path }}/repos"

    # 3. Workspace Mapping
    - name: "Symlink Workspace to NVMe"
      file:
        src: "{{ nvme_path }}/repos"
        dest: "{{ workspace_dir }}"
        state: link
        force: yes

    - name: "Ensure repos subdirectory in Workspace"
      file:
        path: "{{ workspace_dir }}/repos"
        state: directory

    # 4. Interface and Productivity Tools
    - name: "Install productivity tools on Host via Brew"
      shell: "brew install {{ item }}"
      loop:
        - tmux # Terminal Multiplexer
        - stow # Dotfile Manager
        - zoxide # Smarter cd
        - fzf # Fuzzy Finder
        - jq # JSON Processor
        - eza # Modern ls
        - bat # Modern cat
        - ripgrep # Fast grep
        - fd # Fast find
        - lazygit # Git TUI
        - lazydocker # Docker TUI
        - yq # YAML Processor
        - bitwarden-cli # CLI Password Manager
      register: brew_result
      changed_when: "'already installed' not in brew_result.stderr"

    # 4.1 DevPod (Linux Binary - Correct Method)
    - name: "Install DevPod via Direct Download"
      get_url:
        url: "https://github.com/loft-sh/devpod/releases/latest/download/devpod-linux-amd64"
        dest: "/home/linuxbrew/.linuxbrew/bin/devpod"
        mode: "0755"

    # 4.2 TPM (Tmux Plugin Manager)
    - name: "Install TPM (Tmux Plugin Manager)"
      git:
        repo: "https://github.com/tmux-plugins/tpm"
        dest: "{{ ansible_facts['env']['HOME'] }}/.tmux/plugins/tpm"

    # 5. GitOps - Cloning
    - name: "Clone repositories to Workspace/repos"
      git:
        repo: "{{ item.url }}"
        dest: "{{ workspace_dir }}/repos/{{ item.name }}"
        accept_hostkey: yes
      with_items: "{{ repositories }}"
      async: 45
      poll: 0
      register: git_clone_jobs

    - name: "Wait for all repositories to be cloned"
      ansible.builtin.async_status:
        jid: "{{ item.ansible_job_id }}"
      with_items: "{{ git_clone_jobs.results }}"
      register: git_clone_status
      until: git_clone_status.finished
      retries: 30
      delay: 5

    # 6. Global Git Configuration (Identity)
    - name: "Configure Git Identity"
      community.general.git_config:
        name: "{{ item.key }}"
        scope: global
        value: "{{ item.value }}"
      loop:
        - { key: "user.name", value: "{{ git_name }}" }
        - { key: "user.email", value: "{{ git_email }}" }
        - { key: "gpg.format", value: "ssh" }
        - { key: "commit.gpgsign", value: "true" } # Force global signing

    # 7. SSH Signing Automation (Detects key in RAM)
    - name: "Configure Git signing key (If available in RAM)"
      shell: |
        SSH_KEY=$(ssh-add -L 2>/dev/null | head -n1 | awk '{print $1, $2}')
        if [ -n "$SSH_KEY" ]; then
          git config --global user.signingkey "$SSH_KEY"
          echo "changed"
        else
          echo "skipped"
        fi
      register: git_signing
      changed_when: "'changed' in git_signing.stdout"
      ignore_errors: true

    # 7.5 Ensure .bashrc loads .bash_aliases
    - name: "Configure .bashrc to load aliases"
      lineinfile:
        path: "{{ ansible_facts['env']['HOME'] }}/.bashrc"
        line: "[ -f ~/.bash_aliases ] && . ~/.bash_aliases"
        state: present
        create: yes

    # 8. Dotfiles
    - name: "Apply dotfiles via GNU Stow"
      shell: "stow --dir={{ dotfiles_dir }} --target={{ ansible_facts['env']['HOME'] }} --restow {{ item }}"
      with_items:
        - "tmux"
        - "bash"
